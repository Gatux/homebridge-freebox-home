#!/bin/bash

CURL_EXISTS=`which curl`

if [ ! -d ${CURL_EXISTS} ]; then
    echo "[i] Installing curl..."
    sudo apt-get --assume-yes install curl
    echo "[>] Done."
fi

NODE_EXISTS=`which curl`

if [ ! -d ${NODE_EXISTS} ]; then
    echo "[i] Installing nodejs..."
    curl -sL https://deb.nodesource.com/setup_13.x | sudo -E bash -
    sudo apt-get --assume-yes install nodejs
    sudo apt-get --assume-yes install npm
    sudo npm cache clean -f
    sudo npm install -g n
    sudo n stable
    PATH="$PATH"
    echo "[>] Done."
fi

echo "[i] Check npm version"
sudo npm install npm@latest -g

HOMEBRIDGE_EXISTS=`which homebridge`

if [ ! -d ${HOMEBRIDGE_EXISTS} ]; then
    echo "[i] Installing homebridge..."
    sudo npm install -g --unsafe-perm homebridge
    echo "[>] Done."
fi

echo "[i] Checking homebridge plugins..."

if [ `npm list -g | grep -c homebridge-http-pir-motion-sensor` -eq 0 ]; then
    echo "[i] Motion sensor"
    sudo npm install -g homebridge-http-pir-motion-sensor
fi

if [ `npm list -g | grep -c homebridge-http-contact-sensor` -eq 0 ]; then
    echo "[i] Contact sensor"
    sudo npm install -g homebridge-http-contact-sensor
fi

if [ `npm list -g | grep -c homebridge-http-contact-sensor` -eq 0 ]; then
    echo "[i] Alarm"
    sudo npm install -g homebridge-http-securitysystem
fi

echo "[>] Done."

PM_EXISTS=`which pm2`

if [ ! -d ${PM_EXISTS} ]; then
    echo "[i] Installing node process manager..."
    sudo npm install -g pm2
    echo "[>] Done."
fi

echo "[i] Installing dependancies for freebox home server"
npm install
touch .env && printf "TOKEN=null\nTRACK=null" > .env
echo "[>] Done."

echo "[i] Starting services"
pm2
#pm2 startup

#pm2 start /usr/bin/homebridge -l ~/log/homebridge
#pm2 start index.js -l ~/log/server
#pm2 save